# SPDX-FileCopyrightText: 2025 ETH Zurich and University of Bologna
#
# SPDX-License-Identifier: Apache-2.0

---
name: CI â€¢ Siracusa

"on":
  push:
    branches:
      - "**"
    tags:
      - "v*.*.*"
  pull_request:
  workflow_dispatch:
    inputs:
      docker_image_deeploy:
        description: "Deeploy Image to use"
        required: false
        default: "ghcr.io/pulp-platform/deeploy:devel"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  select-env:
    uses: ./.github/workflows/_select-env.yml
    with:
      docker_image_deeploy: ${{ inputs.docker_image_deeploy }}

  siracusa-kernels:
    needs: select-env
    uses: ./.github/workflows/_runner-siracusa.yml
    with:
      runner: ${{ needs.select-env.outputs.runner }}
      docker-image: ${{ needs.select-env.outputs.image }}
      test-names: |
        FP32Kernels/Activations/ReLU

        FP32Kernels/Activations/Softmax/CrossEntropy
        FP32Kernels/Activations/Softmax/CrossEntropyGrad
        FP32Kernels/Activations/Softmax/Grad
        FP32Kernels/Activations/Softmax/Regular

        FP32Kernels/Add/regular

        FP32Kernels/Conv2D/DWBias
        FP32Kernels/Conv2D/DWNoBias
        FP32Kernels/Conv2D/DWZeroValuedBias
        FP32Kernels/Conv2D/RegularBias
        FP32Kernels/Conv2D/RegularNoBias
        FP32Kernels/Conv2D/RegularZeroValuedBias

        FP32Kernels/GEMM/regular
        FP32Kernels/MatMul
        FP32Kernels/MaxPool
        FP32Kernels/Mul
        FP32Kernels/Norm/LayerNorm

        FP32Kernels/ReduceMean/KeepDims/Add_ReduceMean
        FP32Kernels/ReduceMean/KeepDims/Add_ReduceMean_Add
        FP32Kernels/ReduceMean/KeepDims/AllAxes
        FP32Kernels/ReduceMean/KeepDims/Axes1_2_3
        FP32Kernels/ReduceMean/KeepDims/Axes1_3
        FP32Kernels/ReduceMean/KeepDims/Axes2_1
        FP32Kernels/ReduceMean/KeepDims/Axis0
        FP32Kernels/ReduceMean/KeepDims/Axis2
        FP32Kernels/ReduceMean/KeepDims/ReduceMean_Add

        FP32Kernels/ReduceMean/NoKeepDims/Add_ReduceMean
        FP32Kernels/ReduceMean/NoKeepDims/Add_ReduceMean_Add
        FP32Kernels/ReduceMean/NoKeepDims/AllAxes
        FP32Kernels/ReduceMean/NoKeepDims/Axes1_2_3
        FP32Kernels/ReduceMean/NoKeepDims/Axes1_3
        FP32Kernels/ReduceMean/NoKeepDims/Axes2_1
        FP32Kernels/ReduceMean/NoKeepDims/Axis0
        FP32Kernels/ReduceMean/NoKeepDims/Axis2
        FP32Kernels/ReduceMean/NoKeepDims/ReduceMean_Add

        FP32Kernels/ReduceSum
        FP32Kernels/SkipConnection/ReshapeWithSkipConnection

        FP32Kernels/Transpose

        IntKernels/Activations/Hardswish
        IntKernels/Activations/Softmax/Regular

        IntKernels/Add/MultIO
        IntKernels/Add/Regular

        IntKernels/Concat

        IntKernels/MatMul/add
        IntKernels/MatMul/regular

        IntKernels/Pad/1D
        IntKernels/Pad/2D

        IntKernels/RMSNorm

        Models/TinyViT/5M/Layers/FP32/ReduceMean

        Others/Backtracking
        Others/Dequant
        Others/Quant
        Others/QuantizedLinear
        Others/RequantizedConv2D
        Others/RequantizedDWConv
        Others/RQHardswish
        Others/trueIntegerDivSandwich
      num-cores: 8

  siracusa-models:
    needs: select-env
    uses: ./.github/workflows/_runner-siracusa.yml
    with:
      runner: ${{ needs.select-env.outputs.runner }}
      docker-image: ${{ needs.select-env.outputs.image }}
      test-names: |
        IntKernels/Attention

        Models/CCT/FP32/CCT_1_16_16_8
        Models/CCT/FP32/CCT_2_32_32_128_Opset20

        Models/miniMobileNet
        Models/miniMobileNetv2

        Models/MLPerf/KeywordSpotting
        Models/MLPerf/ImageClassification
        Models/MLPerf/AnomalyDetection

        Models/TinyViT/Demo

        Others/SimpleRegression
        Others/TrainCCT/CCT1_Classifier_Training/CCT_1_16_16_8
      num-cores: 8
