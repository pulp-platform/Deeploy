# SPDX-FileCopyrightText: 2025 ETH Zurich and University of Bologna
#
# SPDX-License-Identifier: Apache-2.0

---
name: CI â€¢ Siracusa

"on":
  push:
    branches:
      - "**"
    tags:
      - "v*.*.*"
  pull_request:
  workflow_dispatch:
    inputs:
      docker_image_deeploy:
        description: "Deeploy Image to use"
        required: false
        default: "ghcr.io/pulp-platform/deeploy:devel"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  select-env:
    uses: ./.github/workflows/_select-env.yml
    with:
      docker_image_deeploy: ${{ inputs.docker_image_deeploy }}

  siracusa-kernels:
    needs: select-env
    uses: ./.github/workflows/_runner-siracusa.yml
    with:
      runner: ${{ needs.select-env.outputs.runner }}
      docker-image: ${{ needs.select-env.outputs.image }}
      test-names: |
        Adder

        FP32Kernels/Activations/ReLU

        FP32Kernels/Conv2D/DWBias
        FP32Kernels/Conv2D/DWNoBias
        FP32Kernels/Conv2D/DWZeroValuedBias

        FP32Kernels/Conv2D/RegularBias
        FP32Kernels/Conv2D/RegularNoBias
        FP32Kernels/Conv2D/RegularZeroValuedBias

        FP32Kernels/ReduceMean/KeepDims/Add_ReduceMean
        FP32Kernels/ReduceMean/KeepDims/Add_ReduceMean_Add
        FP32Kernels/ReduceMean/KeepDims/AllAxes
        FP32Kernels/ReduceMean/KeepDims/Axes1_2_3
        FP32Kernels/ReduceMean/KeepDims/Axes1_3
        FP32Kernels/ReduceMean/KeepDims/Axes2_1
        FP32Kernels/ReduceMean/KeepDims/Axis0
        FP32Kernels/ReduceMean/KeepDims/Axis2
        FP32Kernels/ReduceMean/KeepDims/ReduceMean_Add

        FP32Kernels/ReduceMean/NoKeepDims/Add_ReduceMean
        FP32Kernels/ReduceMean/NoKeepDims/Add_ReduceMean_Add
        FP32Kernels/ReduceMean/NoKeepDims/AllAxes
        FP32Kernels/ReduceMean/NoKeepDims/Axes1_2_3
        FP32Kernels/ReduceMean/NoKeepDims/Axes1_3
        FP32Kernels/ReduceMean/NoKeepDims/Axes2_1
        FP32Kernels/ReduceMean/NoKeepDims/Axis0
        FP32Kernels/ReduceMean/NoKeepDims/Axis2
        FP32Kernels/ReduceMean/NoKeepDims/ReduceMean_Add

        FP32Kernels/SkipConnection/ReshapeWithSkipConnection

        Models/TinyViT/5M/Layers/FP32/ReduceMean

        MultIO
        test1DPad
        test2DPad
        testMatMul
        testMatMulAdd
        testRequantizedDWConv
        test2DRequantizedConv
        iSoftmax
        testConcat
        testRMSNorm
        trueIntegerDivSandwich
        Hardswish
        RQHardswish
        testBacktracking
        testFloatAdder
        testFloatGEMM
        testFloatLayerNorm
        testFloatMaxPool
        testFloatMatmul
        testFloatSoftmax
        testFloatTranspose
        testFloatMul
        Quant
        Dequant
        testFloatReduceSum
        testFloatSoftmaxGrad
        testFloatSoftmaxCrossEntropy
        testFloatSoftmaxCrossEntropyGrad
        QuantizedLinear
      num-cores: 8

  siracusa-models:
    needs: select-env
    uses: ./.github/workflows/_runner-siracusa.yml
    with:
      runner: ${{ needs.select-env.outputs.runner }}
      docker-image: ${{ needs.select-env.outputs.image }}
      test-names: |
        simpleRegression
        miniMobileNet
        miniMobileNetv2
        Attention
        MLPerf/KeywordSpotting
        MLPerf/ImageClassification
        MLPerf/AnomalyDetection
        CCT/CCT_1_16_16_8
        CCT/CCT_2_32_32_128_Opset20
        testFloatDemoTinyViT
      num-cores: 8
