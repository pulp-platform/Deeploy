# Copyright (C) 2025, ETH Zurich and University of Bologna.
# Licensed under the Apache License, Version 2.0, see LICENSE for details.
# SPDX-License-Identifier: Apache-2.0

---
name: CI â€¢ Siracusa

"on":
  push:
    branches:
      - "**"
    tags:
      - "v*.*.*"
  pull_request:
  workflow_dispatch:
    inputs:
      docker_image_deeploy:
        description: "Deeploy Image to use"
        required: false
        default: "ghcr.io/pulp-platform/deeploy:devel"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  select-env:
    uses: ./.github/workflows/_select-env.yml
    with:
      docker_image_deeploy: ${{ inputs.docker_image_deeploy }}

  siracusa-kernels:
    needs: select-env
    uses: ./.github/workflows/_runner-siracusa.yml
    with:
      runner: ${{ needs.select-env.outputs.runner }}
      docker-image: ${{ needs.select-env.outputs.image }}
      test-names: |
        Adder
        MultIO
        test1DPad
        test2DPad
        testMatMul
        testMatMulAdd
        testRequantizedDWConv
        test2DRequantizedConv
        iSoftmax
        testConcat
        testRMSNorm
        trueIntegerDivSandwich
        Hardswish
        RQHardswish
        testBacktracking
        testFloatAdder
        testFloatGEMM
        testFloat2DConvolution
        testFloatLayerNorm
        testFloatRelu
        testFloatMaxPool
        testFloatMatmul
        testFloatSoftmax
        testFloatTranspose
        testFloatMul
        Quant
        Dequant
        testFloatReduceSum
        testFloatSoftmaxGrad
        testFloatSoftmaxCrossEntropy
        testFloatSoftmaxCrossEntropyGrad
        QuantizedLinear
      num-cores: 8

  siracusa-models:
    needs: select-env
    uses: ./.github/workflows/_runner-siracusa.yml
    with:
      runner: ${{ needs.select-env.outputs.runner }}
      docker-image: ${{ needs.select-env.outputs.image }}
      test-names: |
        simpleRegression
        miniMobileNet
        miniMobileNetv2
        Attention
        MLPerf/KeywordSpotting
        MLPerf/ImageClassification
        MLPerf/AnomalyDetection
        CCT/CCT_1_16_16_8
        testTrainCCT/CCT1_Classifier_Training/CCT_1_16_16_8
      num-cores: 8
