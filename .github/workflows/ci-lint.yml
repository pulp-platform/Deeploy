# Copyright (C) 2025, ETH Zurich and University of Bologna.
# Licensed under the Apache License, Version 2.0, see LICENSE for details.
# SPDX-License-Identifier: Apache-2.0

---
name: CI â€¢ Lint & Licenses

"on":
  push:
    branches:
      - "**"
    tags:
      - "v*.*.*"
  pull_request:
  workflow_dispatch:
    inputs:
      docker_image_deeploy:
        description: "Deeploy Image to use"
        required: false
        default: "ghcr.io/pulp-platform/deeploy:devel"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  select-env:
    uses: ./.github/workflows/_select-env.yml
    with:
      docker_image_deeploy: ${{ inputs.docker_image_deeploy }}

  linting:
    needs: select-env
    runs-on: ${{ needs.select-env.outputs.runner }}
    container:
      image: ${{ needs.select-env.outputs.image }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Build Deeploy
        shell: bash
        run: |
          pip install . --extra-index-url=https://pypi.ngc.nvidia.com
          pip install -r requirements-dev.txt
      - name: Format Python
        shell: bash
        run: |
          yapf -rpd -e "third_party/" -e "install/" -e "toolchain/" .
      - name: Format Python Imports
        shell: bash
        run: |
          isort --quiet --sg "**/third_party/*" --sg "install/*" --sg "toolchain/*" ./ -c
          autoflake --quiet -c -r --remove-all-unused-imports --ignore-init-module-imports --exclude "**/third_party/*,**/install/*,**/toolchain/*" .
      - name: Format C
        shell: bash
        run: |
          python scripts/run_clang_format.py -e "*/third_party/*" -e "*/install/*" -e "*/toolchain/*" -r --clang-format-executable=${LLVM_INSTALL_DIR}/bin/clang-format . scripts
      - name: Format YAML
        shell: bash
        run: |
          yamllint .
      - name: Check Licenses
        shell: bash
        run: |
          python scripts/license_fix.py --check $(git ls-files '*.py' '*.c' '*.h' '*.html' '*.rst' '*.yml' '*.yaml')
