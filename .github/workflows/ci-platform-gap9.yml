# SPDX-FileCopyrightText: 2025 ETH Zurich and University of Bologna
#
# SPDX-License-Identifier: Apache-2.0

---
name: CI â€¢ GAP9

"on":
  push:
    branches:
      - "**"
    tags:
      - "v*.*.*"
  pull_request:
  workflow_dispatch:
    inputs:
      docker_image_deeploy:
        description: "Deeploy Image to use"
        required: false
        default: "ghcr.io/pulp-platform/deeploy:devel"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  select-env:
    uses: ./.github/workflows/_select-env.yml
    with:
      docker_image_deeploy: ${{ inputs.docker_image_deeploy }}

  gap9-kernels:
    needs: select-env
    uses: ./.github/workflows/_runner-gap9.yml
    with:
      runner: ${{ needs.select-env.outputs.runner }}
      docker-image: ${{ needs.select-env.outputs.image }}
      test-names: |
        Adder
        MultIO
        test1DPad
        test2DPad
        testMatMul
        testMatMulAdd
        testRequantizedDWConv
        test2DRequantizedConv
        iSoftmax
        testConcat
        testRMSNorm
        trueIntegerDivSandwich
        Hardswish
        RQHardswish
        testBacktracking
        testFloatAdder
        testFloatGEMM

        testFloat2DConvolution
        testFloat2DConvolutionBias
        testFloat2DConvolutionZeroBias

        testFloat2DDWConvolution
        testFloat2DDWConvolutionBias
        testFloat2DDWConvolutionZeroBias

        testFloatLayerNorm
        testFloatRelu
        testFloatMaxPool
        testFloatMatmul
        testFloatSoftmax
        testFloatTranspose
        testFloatMul
        Quant
        Dequant
        testFloatReduceSum
        testFloatReshapeWithSkipConnection
        QuantizedLinear
      num-cores: 8

  gap9-models:
    needs: select-env
    uses: ./.github/workflows/_runner-gap9.yml
    with:
      runner: ${{ needs.select-env.outputs.runner }}
      docker-image: ${{ needs.select-env.outputs.image }}
      test-names: |
        simpleRegression
        miniMobileNet
        miniMobileNetv2
        Attention
        MLPerf/KeywordSpotting
        MLPerf/ImageClassification
        MLPerf/AnomalyDetection
      num-cores: 8
