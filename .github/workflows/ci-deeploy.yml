# SPDX-FileCopyrightText: 2025 ETH Zurich and University of Bologna
#
# SPDX-License-Identifier: Apache-2.0

---
name: CI â€¢ Deeploy

"on":
  push:
    branches:
      - "**"
    tags:
      - "v*.*.*"
  pull_request:
  workflow_dispatch:
    inputs:
      docker_image_deeploy:
        description: "Deeploy Image to use"
        required: false
        default: "ghcr.io/pulp-platform/deeploy:devel"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  select-env:
    uses: ./.github/workflows/_select-env.yml
    with:
      docker_image_deeploy: ${{ inputs.docker_image_deeploy }}

  build-deeploy:
    needs: select-env
    runs-on: ${{ needs.select-env.outputs.runner }}
    container:
      image: ${{ needs.select-env.outputs.image }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Build Deeploy
        shell: bash
        run: pip install -e .

  deeploy-memory-allocation:
    needs: select-env
    runs-on: ${{ needs.select-env.outputs.runner }}
    container:
      image: ${{ needs.select-env.outputs.image }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Build Deeploy
        shell: bash
        run: pip install -e .
      - name: Run Test
        shell: bash
        run: |
          cd DeeployTest
          python testMVP.py -t Tests/Models/CCT/FP32/CCT_1_16_16_8 -p Siracusa --defaultMemLevel=L2 --l1=64000 --l2=75000 --memAllocStrategy=MiniMalloc
          python testMVP.py -t Tests/Models/CCT/FP32/CCT_1_16_16_8 -p Siracusa --defaultMemLevel=L2 --l1=64000 --l2=60000 --memAllocStrategy=MiniMalloc --shouldFail
          python testMVP.py -t Tests/Models/CCT/FP32/CCT_1_16_16_8 -p Siracusa --defaultMemLevel=L2 --l1=64000 --l2=90000 --memAllocStrategy=TetrisRandom
          python testMVP.py -t Tests/Models/CCT/FP32/CCT_1_16_16_8 -p Siracusa --defaultMemLevel=L2 --l1=64000 --l2=75000 --memAllocStrategy=TetrisRandom --shouldFail

  deeploy-state-serialization:
    needs: select-env
    runs-on: ${{ needs.select-env.outputs.runner }}
    container:
      image: ${{ needs.select-env.outputs.image }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Build Deeploy
        shell: bash
        run: pip install -e .
      - name: Run Test
        shell: bash
        run: |
          cd DeeployTest
          python deeployStateEqualityTest.py -t ./Tests/Models/CNN_Linear2 -p QEMU-ARM
          python deeployStateEqualityTest.py -t ./Tests/Models/CNN_Linear2 -p Siracusa
          python deeployStateEqualityTest.py -t ./Tests/Models/CNN_Linear2 -p MemPool
          python deeployStateEqualityTest.py -t ./Tests/Models/CNN_Linear2 -p Generic

  deeploy-memory-level-extension:
    needs: select-env
    runs-on: ${{ needs.select-env.outputs.runner }}
    container:
      image: ${{ needs.select-env.outputs.image }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Build Deeploy
        shell: bash
        run: pip install -e .
      - name: Run Test
        shell: bash
        run: |
          cd DeeployTest
          python testMemoryLevelExtension.py -t ./Tests/Models/CNN_Linear2 -p QEMU-ARM
          python testMemoryLevelExtension.py -t ./Tests/Models/CNN_Linear2 -p Siracusa
          python testMemoryLevelExtension.py -t ./Tests/Models/CNN_Linear2 -p MemPool
          python testMemoryLevelExtension.py -t ./Tests/Models/CNN_Linear2 -p Generic

  deeploy-tiler-extension:
    needs: select-env
    runs-on: ${{ needs.select-env.outputs.runner }}
    container:
      image: ${{ needs.select-env.outputs.image }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Build Deeploy
        shell: bash
        run: pip install -e .
      - name: Run Test
        shell: bash
        run: |
          cd DeeployTest
          python testTilerExtension.py -p Siracusa -t ./Tests/Models/CNN_Linear2
          python testTilerExtension.py -p Siracusa -t ./Tests/Models/CNN_Linear1
          python testTilerExtension.py -p Siracusa -t ./Tests/Kernels/Integer/MatMul/Regular
          python testTilerExtension.py -p Siracusa -t ./Tests/Kernels/Integer/MaxPool/Regular_2D
          python testTilerExtension.py -p Siracusa -t ./Tests/Models/CNN_Linear2 --l1 2000 --shouldFail
          python testTilerExtension.py -p Siracusa -t ./Tests/Models/CNN_Linear1 --l1 2000 --shouldFail
          python testTilerExtension.py -p Siracusa -t ./Tests/Kernels/Integer/MatMul/Regular --l1 2000 --shouldFail
          python testTilerExtension.py -p Siracusa -t ./Tests/Kernels/Integer/MaxPool/Regular_2D --l1 2000 --shouldFail

  deeploy-memory-allocation-extension:
    needs: select-env
    runs-on: ${{ needs.select-env.outputs.runner }}
    container:
      image: ${{ needs.select-env.outputs.image }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Build Deeploy
        shell: bash
        run: pip install -e .
      - name: Run Test
        shell: bash
        run: |
          cd DeeployTest
          python testTilerExtension.py -p Siracusa -t ./Tests/Models/CNN_Linear2
          python testTilerExtension.py -p Siracusa -t ./Tests/Models/CNN_Linear1
          python testTilerExtension.py -p Siracusa -t ./Tests/Models/miniMobileNet
          python testTilerExtension.py -p Siracusa -t ./Tests/Models/miniMobileNetv2
          python testTilerExtension.py -p Siracusa -t ./Tests/Kernels/Integer/MatMul/Regular
          python testTilerExtension.py -p Siracusa -t ./Tests/Kernels/Integer/MaxPool/Regular_2D

  deeploy-typing:
    needs: select-env
    runs-on: ${{ needs.select-env.outputs.runner }}
    container:
      image: ${{ needs.select-env.outputs.image }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Build Deeploy
        shell: bash
        run: pip install -e .
      - name: Run Test
        shell: bash
        run: |
          cd DeeployTest
          python testTypes.py

  deeploy-debug:
    needs: select-env
    runs-on: ${{ needs.select-env.outputs.runner }}
    container:
      image: ${{ needs.select-env.outputs.image }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Build Deeploy
        shell: bash
        run: pip install -e .
      - name: Run Test
        shell: bash
        run: |
          cd DeeployTest
          python testPrintInputOutputTransformation.py -p Generic -t ./Tests/Models/CNN_Linear2
          python testPrintInputOutputTransformation.py -p Siracusa -t ./Tests/Models/CNN_Linear2
          python testDebugPrintPass.py -p Generic -t ./Tests/Models/CNN_Linear2

  deeploy-regex-matching:
    needs: select-env
    runs-on: ${{ needs.select-env.outputs.runner }}
    container:
      image: ${{ needs.select-env.outputs.image }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Build Deeploy
        shell: bash
        run: pip install -e .
      - name: Run Test
        shell: bash
        run: |
          cd DeeployTest
          python testRegexMatching.py

  deeploy-test-dmas:
    needs: select-env
    runs-on: ${{ needs.select-env.outputs.runner }}
    container:
      image: ${{ needs.select-env.outputs.image }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Build Deeploy
        shell: bash
        run: pip install -e .
      - name: Run Test
        shell: bash
        run: |
          cd DeeployTest
          python testDmas.py
